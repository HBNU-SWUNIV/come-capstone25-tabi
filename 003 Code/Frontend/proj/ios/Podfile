source 'https://cdn.cocoapods.org/'

def node_require(script)
  # Resolve script with node to allow for hoisting
  require Pod::Executable.execute_command('node', ['-p',
    "require.resolve(
      '#{script}',
      {paths: [process.argv[1]]},
    )", __dir__]).strip
end

# Use it to require both react-native's and this package's scripts:
node_require('react-native/scripts/react_native_pods.rb')
node_require('react-native-permissions/scripts/setup.rb')

ENV['RCT_NEW_ARCH_ENABLED'] = '1'
ENV['USE_CODEGEN_DISCOVERY'] = '1'

require_relative '../node_modules/react-native/scripts/react_native_pods'

platform :ios, '15.1'
config = use_native_modules!
prepare_react_native_project!

target 'proj' do
  # use_frameworks! :linkage => :static # RN 0.76 에서는 X, 0.81 에서는 문제 없었음.

  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => true,
    :new_arch_enabled => true,
  )

  setup_permissions([
    'AppTrackingTransparency',
    # 'BluetoothPeripheral',
    # 'Calendars',
    'Camera',
    # 'Contacts',
    # 'FaceID',
    'LocationAccuracy',
    'LocationAlways',
    'LocationWhenInUse',
    # 'MediaLibrary',
    # 'Microphone',
    # 'Motion',
    'Notifications',
    'PhotoLibrary',
    # 'PhotoLibraryAddOnly',
    # 'Reminders',
    # 'SpeechRecognition',
    # 'StoreKit'
  ])
  
  pod 'ViroReact', :path => '../node_modules/@reactvision/react-viro/ios/'
  pod 'ViroKit', :path => '../node_modules/@reactvision/react-viro/ios/dist/ViroRenderer/'

  # Maps
  pod 'react-native-maps/Google', :path => '../node_modules/react-native-maps'
  # pod 'GoogleMaps' => 9.3.0 으로 맞춤 (react-native-maps 1.25.3 기준)
  # pod 'Google-Maps-iOS-Utils' => 6.1.0 으로 맞춤 (react-native-maps 1.25.3 기준)

  # Screens / SafeArea
  pod 'RNScreens', :path => '../node_modules/react-native-screens'
  pod 'react-native-safe-area-context', :path => '../node_modules/react-native-safe-area-context'

  post_install do |installer|
    react_native_post_install(installer)

    def ensure_macro!(bs, macro)
      defs = bs['GCC_PREPROCESSOR_DEFINITIONS'] || ['$(inherited)']
      defs = [defs] if defs.is_a?(String)
      defs << macro unless defs.any? { |d| d.to_s.include?(macro) }
      bs['GCC_PREPROCESSOR_DEFINITIONS'] = defs
    end

    std_flag = '-std=gnu++20' # ✅ C++20로 올림

    # 1) Pods 프로젝트 레벨(전역) 먼저 적용
    installer.pods_project.build_configurations.each do |cfg|
      cfg.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'gnu++20'
      cfg.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
      cfg.build_settings['GCC_C_LANGUAGE_STANDARD'] = 'gnu11'

      other_cpp = cfg.build_settings['OTHER_CPLUSPLUSFLAGS'] || '$(inherited)'
      other_cpp = [other_cpp] unless other_cpp.is_a?(Array)
      unless other_cpp.any? { |f| f.to_s.include?(std_flag) }
        # 기존 -std=gnu++17 같은 게 남아있을 수도 있으니 정리
        other_cpp = other_cpp.reject { |f| f.to_s.start_with?('-std=') }
        other_cpp << std_flag
      end
      cfg.build_settings['OTHER_CPLUSPLUSFLAGS'] = other_cpp
    end

    # 2) 각 타깃에도 다시 적용
    installer.pods_project.targets.each do |t|
      t.build_configurations.each do |cfg|
        ensure_macro!(cfg.build_settings, 'RCT_NEW_ARCH_ENABLED=1')

        cfg.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'gnu++20'
        cfg.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
        cfg.build_settings['GCC_C_LANGUAGE_STANDARD'] = 'gnu11'

        other_cpp = cfg.build_settings['OTHER_CPLUSPLUSFLAGS'] || '$(inherited)'
        other_cpp = [other_cpp] unless other_cpp.is_a?(Array)
        unless other_cpp.any? { |f| f.to_s.include?(std_flag) }
          other_cpp = other_cpp.reject { |f| f.to_s.start_with?('-std=') }
          other_cpp << std_flag
        end
        cfg.build_settings['OTHER_CPLUSPLUSFLAGS'] = other_cpp

        # 정확히 RNScreens 타깃에만 매크로 추가
        if t.name == 'RNScreens'
          ensure_macro!(cfg.build_settings, 'RNS_NEW_ARCH_ENABLED=1')
        end
      end
    end
  end
end